{
  "active": false,
  "connections": {
    "Trigger cada minuto": {
      "main": [
        [
          {
            "node": "Buscar √∫ltimas filas Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar √∫ltimas filas Airtable": {
      "main": [
        [
          {
            "node": "Verificar si es registro nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar si es registro nuevo": {
      "main": [
        [
          {
            "node": "¬øEs registro nuevo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs registro nuevo?": {
      "main": [
        [
          {
            "node": "Generar contenido del albar√°n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar contenido del albar√°n": {
      "main": [
        [
          {
            "node": "Crear documento en Google Docs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear documento en Google Docs": {
      "main": [
        [
          {
            "node": "Mover a carpeta de albaranes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mover a carpeta de albaranes": {
      "main": [
        [
          {
            "node": "Enviar albar√°n por Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar albar√°n por Gmail": {
      "main": [
        [
          {
            "node": "Actualizar registro en Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-02T21:30:36.870Z",
  "id": "ovsSoAMw2RuRlZTK",
  "isArchived": false,
  "meta": null,
  "name": "Buscar pedidos NO actualizados",
  "nodes": [
    {
      "id": "c623f50d-7516-4b58-97d3-1cc2d83f2c9a",
      "name": "Trigger cada minuto",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        580,
        460
      ],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        }
      }
    },
    {
      "id": "8a9b2c3d-4e5f-6789-abcd-ef1234567890",
      "name": "Buscar √∫ltimas filas Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        800,
        460
      ],
      "parameters": {
        "authentication": "airtableTokenApi",
        "resource": "record",
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "YOUR_AIRTABLE_BASE_ID",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "YOUR_TABLE_NAME",
          "mode": "list"
        },
        "options": {
          "sort": [
            {
              "field": "Created",
              "direction": "desc"
            }
          ],
          "maxRecords": 1
        }
      }
    },
    {
      "id": "1f2g3h4i-5j6k-7890-lmno-pqr345678901",
      "name": "Verificar si es registro nuevo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1020,
        460
      ],
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Obtener el timestamp actual\nconst ahora = new Date();\n\n// Obtener el timestamp de creaci√≥n del registro de Airtable\nconst creadoEn = new Date($input.item.json.fields.Created);\n\n// Calcular la diferencia en minutos\nconst diferenciaMinutos = (ahora - creadoEn) / (1000 * 60);\n\n// Si el registro fue creado hace menos de 2 minutos, procesarlo\nif (diferenciaMinutos <= 2) {\n  return {\n    json: {\n      esNuevo: true,\n      registro: $input.item.json,\n      minutosDesdeSuCreacion: diferenciaMinutos\n    }\n  };\n} else {\n  return {\n    json: {\n      esNuevo: false,\n      minutosDesdeSuCreacion: diferenciaMinutos\n    }\n  };\n}"
      }
    },
    {
      "id": "2f3g4h5i-6j7k-8901-mnop-qrs456789012",
      "name": "¬øEs registro nuevo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1240,
        460
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "leftValue": "={{ $json.esNuevo }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "3g4h5i6j-7k8l-9012-nopq-rst567890123",
      "name": "Generar contenido del albar√°n",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1460,
        380
      ],
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extraer datos del registro de Airtable\nconst registro = $input.item.json.registro;\nconst campos = registro.fields;\n\n// Obtener la fecha actual para el albar√°n\nconst fechaActual = new Date().toLocaleDateString('es-ES');\n\n// Generar n√∫mero de albar√°n √∫nico\nconst numeroAlbaran = `ALB-${Date.now()}`;\n\n// Crear el contenido HTML del albar√°n\nconst contenidoAlbaran = `\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Albar√°n ${numeroAlbaran}</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 20px; }\n        .header { text-align: center; margin-bottom: 30px; }\n        .info-section { margin-bottom: 20px; }\n        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n        .table th { background-color: #f2f2f2; }\n        .footer { margin-top: 40px; text-align: center; }\n    </style>\n</head>\n<body>\n    <div class=\"header\">\n        <h1>ALBAR√ÅN DE ENTREGA</h1>\n        <h2>N√∫mero: ${numeroAlbaran}</h2>\n        <p>Fecha: ${fechaActual}</p>\n    </div>\n    \n    <div class=\"info-section\">\n        <h3>Datos del Cliente:</h3>\n        <p><strong>Cliente:</strong> ${campos.Cliente || 'No especificado'}</p>\n        <p><strong>Direcci√≥n:</strong> ${campos.Direccion || 'No especificada'}</p>\n        <p><strong>Tel√©fono:</strong> ${campos.Telefono || 'No especificado'}</p>\n        <p><strong>Email:</strong> ${campos.Email || 'No especificado'}</p>\n    </div>\n    \n    <div class=\"info-section\">\n        <h3>Detalles del Pedido:</h3>\n        <table class=\"table\">\n            <thead>\n                <tr>\n                    <th>Producto</th>\n                    <th>Cantidad</th>\n                    <th>Precio Unitario</th>\n                    <th>Total</th>\n                </tr>\n            </thead>\n            <tbody>\n                <tr>\n                    <td>${campos.Producto || 'Producto no especificado'}</td>\n                    <td>${campos.Cantidad || '1'}</td>\n                    <td>${campos.PrecioUnitario || '0.00'} ‚Ç¨</td>\n                    <td>${campos.Total || '0.00'} ‚Ç¨</td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n    \n    <div class=\"info-section\">\n        <p><strong>Observaciones:</strong> ${campos.Observaciones || 'Sin observaciones'}</p>\n    </div>\n    \n    <div class=\"footer\">\n        <p>Este albar√°n certifica la entrega de los productos arriba mencionados.</p>\n        <p>Fecha y hora de generaci√≥n: ${new Date().toLocaleString('es-ES')}</p>\n    </div>\n</body>\n</html>\n`;\n\nreturn {\n  json: {\n    numeroAlbaran: numeroAlbaran,\n    contenidoHTML: contenidoAlbaran,\n    datosCliente: {\n      cliente: campos.Cliente,\n      email: campos.Email,\n      direccion: campos.Direccion\n    },\n    registroOriginal: registro,\n    fechaGeneracion: fechaActual\n  }\n};"
      }
    },
    {
      "id": "4h5i6j7k-8l9m-0123-opqr-stu678901234",
      "name": "Crear documento en Google Docs",
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        1680,
        380
      ],
      "parameters": {
        "authentication": "oAuth2",
        "resource": "document",
        "operation": "create",
        "driveId": {
          "__rl": true,
          "value": "myDrive",
          "mode": "list"
        },
        "folderId": {
          "__rl": true,
          "value": "YOUR_FOLDER_ID",
          "mode": "list"
        },
        "title": "={{ 'Albar√°n ' + $json.numeroAlbaran + ' - ' + $json.datosCliente.cliente }}",
        "content": "={{ $json.contenidoHTML }}"
      }
    },
    {
      "id": "5i6j7k8l-9m0n-1234-pqrs-tuv789012345",
      "name": "Mover a carpeta de albaranes",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1900,
        380
      ],
      "parameters": {
        "authentication": "oAuth2",
        "resource": "file",
        "operation": "move",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.documentId }}",
          "mode": "id"
        },
        "driveId": {
          "__rl": true,
          "value": "myDrive",
          "mode": "list"
        },
        "folderId": {
          "__rl": true,
          "value": "YOUR_ALBARAN_FOLDER_ID",
          "mode": "list"
        }
      }
    },
    {
      "id": "6j7k8l9m-0n1o-2345-qrst-uvw890123456",
      "name": "Enviar albar√°n por Gmail",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        2120,
        380
      ],
      "parameters": {
        "authentication": "oAuth2",
        "resource": "message",
        "operation": "send",
        "sendTo": "={{ $('Generar contenido del albar√°n').item.json.datosCliente.email }}",
        "subject": "={{ 'Albar√°n ' + $('Generar contenido del albar√°n').item.json.numeroAlbaran + ' - Entrega confirmada' }}",
        "emailType": "html",
        "message": "=Estimado/a {{ $('Generar contenido del albar√°n').item.json.datosCliente.cliente }},<br><br>Adjuntamos el albar√°n correspondiente a su pedido.<br><br>N√∫mero de albar√°n: {{ $('Generar contenido del albar√°n').item.json.numeroAlbaran }}<br>Fecha: {{ $('Generar contenido del albar√°n').item.json.fechaGeneracion }}<br><br>Puede acceder al documento completo en el siguiente enlace:<br><a href=\"https://docs.google.com/document/d/{{ $json.documentId }}\">Ver Albar√°n</a><br><br>Gracias por su confianza.<br><br>Saludos cordiales",
        "options": {
          "attachments": [
            {
              "type": "url",
              "url": "={{ 'https://docs.google.com/document/d/' + $json.documentId + '/export?format=pdf' }}",
              "name": "={{ 'Albaran_' + $('Generar contenido del albar√°n').item.json.numeroAlbaran + '.pdf' }}"
            }
          ]
        }
      }
    },
    {
      "id": "7k8l9m0n-1o2p-3456-rstu-vwx901234567",
      "name": "Actualizar registro en Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        2340,
        380
      ],
      "parameters": {
        "authentication": "airtableTokenApi",
        "resource": "record",
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "YOUR_AIRTABLE_BASE_ID",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "YOUR_TABLE_NAME",
          "mode": "list"
        },
        "id": "={{ $('Generar contenido del albar√°n').item.json.registroOriginal.id }}",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Attachments": [
              {
                "url": "={{ 'https://docs.google.com/document/d/' + $('Mover a carpeta de albaranes').item.json.documentId }}",
                "filename": "={{ 'Albaran_' + $('Generar contenido del albar√°n').item.json.numeroAlbaran + '.pdf' }}"
              }
            ],
            "Estado": "Albar√°n Generado",
            "NumeroAlbaran": "={{ $('Generar contenido del albar√°n').item.json.numeroAlbaran }}",
            "FechaAlbaran": "={{ $('Generar contenido del albar√°n').item.json.fechaGeneracion }}"
          }
        }
      }
    },
    {
      "id": "config-note-1",
      "name": "Configuraci√≥n Inicial",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        320,
        240
      ],
      "parameters": {
        "content": "## üéØ CONFIGURACI√ìN INICIAL REQUERIDA\n\n**IMPORTANTE:** Antes de activar este flujo, debes configurar:\n\n1. **Credenciales de Airtable:**\n   - Obt√©n tu API Token desde https://airtable.com/account\n   - Configura las credenciales en n8n\n\n2. **IDs de Airtable:**\n   - `YOUR_AIRTABLE_BASE_ID`: ID de tu base de Airtable\n   - `YOUR_TABLE_NAME`: Nombre de tu tabla\n\n3. **Credenciales de Google:**\n   - Configura OAuth2 para Google Docs, Drive y Gmail\n   - Autoriza los permisos necesarios\n\n4. **IDs de Google Drive:**\n   - `YOUR_FOLDER_ID`: Carpeta temporal para crear documentos\n   - `YOUR_ALBARAN_FOLDER_ID`: Carpeta final para almacenar albaranes\n\n**‚úÖ VALIDACI√ìN COMPLETADA:**\n- Flujo estructurado correctamente\n- Conexiones v√°lidas entre nodos\n- 8 conexiones principales verificadas\n- Trigger configurado cada minuto"
      }
    },
    {
      "id": "fields-note-1",
      "name": "Campos de Airtable",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        320,
        480
      ],
      "parameters": {
        "content": "## ‚öôÔ∏è CAMPOS ESPERADOS EN AIRTABLE\n\n**Tu tabla debe contener estos campos:**\n- `Created` (fecha/hora de creaci√≥n) - **OBLIGATORIO**\n- `Cliente` (nombre del cliente)\n- `Email` (correo del cliente) - **OBLIGATORIO para env√≠o**\n- `Direccion` (direcci√≥n de entrega)\n- `Telefono` (tel√©fono de contacto)\n- `Producto` (descripci√≥n del producto)\n- `Cantidad` (cantidad solicitada)\n- `PrecioUnitario` (precio por unidad)\n- `Total` (importe total)\n- `Observaciones` (notas adicionales)\n- `Attachments` (se actualizar√° autom√°ticamente)\n- `Estado` (se actualizar√° autom√°ticamente)\n- `NumeroAlbaran` (se asignar√° autom√°ticamente)\n- `FechaAlbaran` (se asignar√° autom√°ticamente)\n\n**üí° CONSEJO:** Usa el campo `Created` como campo de fecha autom√°tica"
      }
    },
    {
      "id": "workflow-note-1",
      "name": "Funcionamiento",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        320,
        720
      ],
      "parameters": {
        "content": "## üîÑ FUNCIONAMIENTO DEL FLUJO\n\n**‚úÖ VALIDADO Y LISTO PARA USAR**\n\n**Paso 1:** Trigger cada minuto busca nuevas filas\n**Paso 2:** Verifica si hay registros creados en los √∫ltimos 2 minutos\n**Paso 3:** Si es nuevo, genera contenido HTML del albar√°n\n**Paso 4:** Crea documento en Google Docs\n**Paso 5:** Mueve el documento a carpeta espec√≠fica\n**Paso 6:** Env√≠a albar√°n por email al cliente\n**Paso 7:** Actualiza el registro original con el enlace\n\n**‚ö° AUTOMATIZACI√ìN COMPLETA:** \nDesde nueva fila ‚Üí Albar√°n creado ‚Üí Email enviado ‚Üí Registro actualizado\n\n**üõ°Ô∏è VALIDACIONES REALIZADAS:**\n- Estructura del flujo ‚úÖ\n- Conexiones entre nodos ‚úÖ\n- Expresiones de n8n ‚úÖ\n- Configuraciones de nodos ‚úÖ"
      }
    },
    {
      "id": "custom-note-1",
      "name": "Personalizaci√≥n",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2100,
        580
      ],
      "parameters": {
        "content": "## üõ†Ô∏è PERSONALIZACI√ìN AVANZADA\n\n**Modifica el nodo 'Generar contenido del albar√°n' para:**\n- Cambiar el dise√±o del albar√°n\n- A√±adir tu logo empresarial\n- Incluir m√°s campos de datos\n- Modificar el formato del n√∫mero de albar√°n\n\n**Ajusta el trigger para:**\n- Cambiar frecuencia (cada 5 min, cada hora, etc.)\n- Usar webhook en lugar de polling\n\n**Personaliza el email:**\n- Modificar plantilla del mensaje\n- A√±adir firma corporativa\n- Cambiar formato del adjunto\n\n**üö® PARA PRODUCCI√ìN A√ëADIR:**\n- Manejo de errores en nodos cr√≠ticos\n- Logging de actividades\n- Notificaciones de fallos\n- Backup de datos importantes"
      }
    }
  ],
  "pinData": null,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Europe/Madrid",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-08-03T10:21:58.186Z",
  "versionId": "9341dfa2-c284-4e6d-a8f9-783c4cd23817"
}